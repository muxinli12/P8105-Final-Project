---
title: "Data Cleaning and Merging"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: sandstone
---

![](images/data cleaning.gif)

## Citibike Database
As the Citibike system data provides monthly database only, we merged all 12 months and two years worth of data into one single database, while filtering variables that are useful to our analysis. The merged data consists of over 700k ride histories, with useful variables that are useful towards our analyses.

The data includes the precise trip duration (in seconds), which allows for granular analysis of ride lengths. This is coupled with the exact start time and date and stop time and date, providing temporal context for peak usage and daily patterns. Geographically, the data is rich, identifying the start station name, end station name, and the corresponding unique station ID for both ends of the trip. For precise spatial analysis, the Station lat/long (latitude/longitude) coordinates are provided, enabling mapping and geographical distribution studies. Furthermore, the specific bike ID tracks the physical bicycle used, which is valuable for maintenance and inventory management. Finally, limited demographic data is included: the user type differentiates between short-term pass holders (customer = 24-hour pass or 3-day pass user) and annual members (subscriber = annual member); Gender is recorded numerically (0 = unknown; 1 = male; 2 = female); and the year of birth offers insight into the age distribution of the ridership.

```{r, message = FALSE}
## Loading necessary packages
library(tidyverse)
library(ggplot2)

## Loading and cleaning data for 2019 ones
bike_files_info = tibble(
  month_code = sprintf("%02d", 1:12),
  month_name = c(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  )) |> 
  mutate(
    file_path = paste0("data/2019/JC-2019", month_code, "-citibike-tripdata.csv")
  )

process_bike_data =
  function(file_path, month_name) {
  if (!file.exists(file_path)) {
    warning(paste("file does not exist, skippedï¼š", file_path))
    return(NULL)
  }
  
  data =
    read_csv(file_path) |>
    janitor::clean_names() |>
    select(
      -start_station_id, -end_station_id, -bikeid, -starttime, -stoptime
    ) |>
    mutate(
      gender = as.factor(gender),
      month = month_name
    )
  
  return(data)
}

list_of_bike_data =
  bike_files_info |>
  select(file_path, month_name) |>
  purrr::pmap(.f = process_bike_data)

all_bike_data_2019 =
  bind_rows(list_of_bike_data) |> 
  mutate(
    year = "2019"
  )

## Loading and cleaning data for 2020 ones
bike_files_info = tibble(
  month_code = sprintf("%02d", 1:12),
  month_name = c(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  )) |> 
  mutate(
    file_path = paste0("data/2020/JC-2020", month_code, "-citibike-tripdata.csv")
  )

process_bike_data =
  function(file_path, month_name) {
    if (!file.exists(file_path)) {
      warning(paste("file does not exist, skippedï¼š", file_path))
      return(NULL)
    }
    
    data =
      read_csv(file_path) |>
      janitor::clean_names() |>
      select(
        -start_station_id, -end_station_id, -bikeid, -starttime, -stoptime
      ) |>
      mutate(
        gender = as.factor(gender),
        month = month_name
      )
    
    return(data)
  }

list_of_bike_data =
  bike_files_info |>
  select(file_path, month_name) |>
  purrr::pmap(.f = process_bike_data)

all_bike_data_2020 =
  bind_rows(list_of_bike_data) |> 
  mutate(
    year = "2020"
  )

bike_df =
  bind_rows(all_bike_data_2019, all_bike_data_2020)

write_csv(bike_df, "data/bike_data_combined.csv")
```

