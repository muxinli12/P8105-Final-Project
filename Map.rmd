---
title: "Citi Bike station map in Jersey City"
output: 
  flexdashboard::flex_dashboard:
    code_folding: hide
    orientation: columns
    vertical_layout: fill
runtime: shiny
---
```{r setup, include=FALSE, echo=FALSE, message=FALSE}
library(flexdashboard)
```

```{r, echo=FALSE, message=FALSE}
library(flexdashboard)
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(leaflet)
library(crosstalk)
library(rvest)
library(httr)
library(plotly)
library(shiny)

data = read.csv("data/bike_data_combined.csv")

map_data = data |>
  select(
    month,
    year,
    start_latitude = start_station_latitude, 
    start_longitude = start_station_longitude,
    end_latitude = end_station_latitude, 
    end_longitude = end_station_longitude) |>
  filter(start_longitude < -74.02, end_longitude < -74.02)

covid_19_testing_centers = read_delim("data/covid_19_testing_centers.csv", delim = ";") |> 
  janitor::clean_names() |> 
  select(latitude, longitude, location_name) |>
  filter(longitude < -74.02, longitude > -74.08 , latitude < 40.75 , latitude > 40.71)

NJ_medical_centers = read_csv("data/NJ_medical_center.csv")
```

```{r, echo=FALSE, message=FALSE}
library(shiny)

create_bike_map <- function(year_sel, input_months, input_stations) {

  req(input_months, input_stations) 

  month_sel <- month.abb[input_months]
  
  if (input_stations == "start") {
    lat_col      <- "start_latitude"
    long_col     <- "start_longitude"
    legend_title <- paste(year_sel, "Start Stations") 
  } else {
    lat_col      <- "end_latitude"
    long_col     <- "end_longitude"
    legend_title <- paste(year_sel, "End Stations") 
  }

  station_counts <- map_data |>
    filter(
      year  == year_sel,
      month == month_sel
    ) |>
    group_by(
      lat  = .data[[lat_col]],
      long = .data[[long_col]]
    ) |>
    summarise(
      n_trips = n(),
      .groups = "drop"
    )

  bins <- quantile(
    station_counts$n_trips,
    probs = seq(0, 1, length.out = 8),
    na.rm = TRUE
  )
  
  pal <- colorBin(
    palette = c("#4292C6", "#9ECAE1", "#DEEBF7" , "#FFFFBF", "#FDAE61", "#F46D43", "#D73027"),
    domain  = station_counts$n_trips,
    bins    = bins,
    pretty  = FALSE
  )
  
 # Square icon
  svg_content <- paste0(
    '<svg width="10" height="10" xmlns="http://www.w3.org/2000/svg">',
    '<rect x="0" y="0" width="10" height="10" ',
    'style="fill:#228B22;" />', 
    '</svg>'
)
  
  encoded_svg <- URLencode(svg_content, reserved = TRUE)
  square_icon <- makeIcon(
      iconUrl = paste0('data:image/svg+xml;charset=UTF-8,', encoded_svg),
      iconWidth = 8,
      iconHeight = 8,
      iconAnchorX = 5, 
      iconAnchorY = 5
  )
  
    
  # Build Leaflet Map
  leaflet(station_counts) |>
    addMapPane("stations_pane", zIndex = 650) |>
    addTiles() |>
    setView(lng = -74.051, lat = 40.7203, zoom = 14) |>
    
    # Covid center
    addMarkers(
      data = covid_19_testing_centers,
      lng = ~longitude,
      lat = ~latitude,
      icon = square_icon, 
      label = ~location_name,
      group = "COVID Centers"
  ) |>
    
    # Medical center
    addAwesomeMarkers(
        data = NJ_medical_centers,
        lng = ~longitude,
        lat = ~latitude,
        icon = awesomeIcons(
            icon = "plus",
            iconColor = "red",
            markerColor = "white",
            library = "fa"
        ),
        label = ~name,
        group = "Medical Centers"
    ) |> 
    
    # Station
    addCircleMarkers(
      lng = ~long,
      lat = ~lat,
      radius = 7,
      fillColor = ~pal(n_trips),
      fillOpacity = 0.9,
      stroke = FALSE,
      label = ~paste("Trips:", n_trips),
      group = "Bike Stations",
      options = markerOptions(pane = "stations_pane")
    ) |>
    
    addLegend(
      pal    = pal,
      values = station_counts$n_trips,
      title  = legend_title,
      opacity = 1
    ) |>
    
    addLayersControl(
      overlayGroups = c("Bike Stations", "COVID Centers", "Medical Centers"),
      options = layersControlOptions(collapsed = FALSE)
    )
}
```

{.sidebar}
-----------------------------------------------------------------------

```{r, echo=FALSE, message=FALSE}

sliderInput(
  "months",
  label   = h3("Month"),
  min     = 1,
  max     = 12,
  value   = 1,
  step    = 1,
  animate = TRUE
)

selectInput(
  "stations", 
  label   = h3("Stations"),
  choices = c("start", "end"),
  selected = "start"
)
```
{data-width=500}
-----------------------------------------------------------------------
### 2019 Trip Counts
```{r, echo=FALSE, message=FALSE}
# 2019 map
renderLeaflet({
  create_bike_map(2019, input$months, input$stations)
})
```
{data-width=500}
-----------------------------------------------------------------------

### 2020 Trip Counts
```{r, echo=FALSE, message=FALSE}
# 2020 map
renderLeaflet({
  create_bike_map(2020, input$months, input$stations)
})
```

---

## City Bike Usage Trends and COVID-19 Correlation in Jersey City (2019 vs 2020)

The analysis of City Bike usage patterns in Jersey City integrates data from **2020 COVID-19 severity** with a comparison of monthly station usage proportions between **2019** and **2020**.

**Based on the geographical and temporal analysis derived from the map visualization (e.g., Plotly Rmd output),** we explore the impact of the pandemic on urban mobility, specifically concerning trips related to medical and clinical centers.

### I. Qualitative Comparison of Monthly Station Usage Proportion

We analyze the monthly proportion of rides starting (Start Station) and ending (End Station) at each City Bike station relative to the total monthly rides.

* **Overall Trend Shift:**
    During the initial phase of the pandemic (Spring 2020), most stations experienced a general decline in total usage and monthly proportion due to lockdown measures. However, a select group of stations catering to essential travel showed **greater resilience** in demand.
* **Commuting Pattern Reimagined:**
    The usage proportion for traditional commuting and business district hubs in 2020 was markedly lower than in 2019. Conversely, certain stations meeting specific critical needs demonstrated a **counter-trend rise** during the peak months of the pandemic.

---

### II. Key Insight: Usage Surge Near Medical and Clinical Centers

***

**Core Finding:** The map visualization clearly revealed that the City Bike stations located near the **Medical Center** (and other Clinical Centers) experienced a **significantly higher** monthly ridership proportion in **2020** compared to the same months in **2019** during the COVID-19 peak periods.

#### 1. Specific Timeline and Peak Observations

This crucial increase in usage around critical health infrastructure was evident across two distinct phases:

1.  **The Spring Outbreak (Starting in April):** Starting from **April 2020**, usage rates at stations surrounding the Medical Center immediately climbed to levels **significantly higher** than those recorded in April 2019. This coincides with the first major wave of the pandemic in New Jersey.
2.  **The Winter Peak:** The usage at these critical stations saw **another surge** during the **winter months** of late 2020, further widening the gap between 2020 and 2019 figures.



#### 2. Qualitative Inference on Travel Purpose

The concentrated rise in usage near medical facilities strongly suggests the following:

* **Support for Essential Workers:** Healthcare and other essential staff working at these centers likely **increasingly chose** City Bike as a personal, low-contact alternative to public transit, ensuring continued access to their critical workplaces.
* **Access to Healthcare:** Residents utilized City Bike to travel to medical facilities for necessary appointments, COVID-19 testing, or vaccinations, indicating that the system served as a **vital, reliable transport option** for essential health trips.

This finding highlights the **critical role** and **resilience** of the City Bike system during a public health crisis. The sharp increase in usage near healthcare facilities confirms the system's ability to support essential city operations and meet crucial mobility needs. Going forward, urban planning must **prioritize strengthening bicycle infrastructure** around major public service centers.